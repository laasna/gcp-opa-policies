# ðŸš€ Sanjana's GCP Cloud Build Integration Guide

## Prerequisites
- Sanjana has a GCP account with billing enabled
- Sanjana's GCP project ID (we'll use this in the setup)
- GitHub repository access: https://github.com/laasna/gcp-opa-policies

## Step 1: Get Sanjana's GCP Project Details

### Information Needed:
- **GCP Project ID**: (Sanjana to provide)
- **GCP Project Number**: (Auto-generated by Google)
- **Preferred Region**: (e.g., us-central1, us-east1)

## Step 2: Update Configuration Files

### Update cloudbuild.yaml:
Replace project references with Sanjana's project ID in:
- Substitution variables
- Service account references
- Any project-specific configurations

### Update infrastructure files:
- Update `infrastructure/gcp-sample.tf` with Sanjana's project ID
- Ensure all GCP resources point to correct project

## Step 3: Sanjana's GCP Setup Commands

### Enable Required APIs:
```bash
# Set Sanjana's project
gcloud config set project SANJANA-PROJECT-ID

# Enable required APIs
gcloud services enable cloudbuild.googleapis.com
gcloud services enable compute.googleapis.com
gcloud services enable storage.googleapis.com
gcloud services enable sourcerepo.googleapis.com
```

### Grant Cloud Build Permissions:
```bash
# Get project number
PROJECT_NUMBER=$(gcloud projects describe SANJANA-PROJECT-ID --format="value(projectNumber)")

# Grant Cloud Build service account necessary permissions
gcloud projects add-iam-policy-binding SANJANA-PROJECT-ID \
  --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
  --role="roles/compute.admin"

gcloud projects add-iam-policy-binding SANJANA-PROJECT-ID \
  --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
  --role="roles/storage.admin"

gcloud projects add-iam-policy-binding SANJANA-PROJECT-ID \
  --member="serviceAccount:$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
  --role="roles/iam.serviceAccountUser"
```

## Step 4: Connect GitHub Repository

### Option A: GitHub App (Recommended)
1. Go to [Cloud Build Triggers](https://console.cloud.google.com/cloud-build/triggers?project=SANJANA-PROJECT-ID)
2. Click "Connect Repository"
3. Select "GitHub (Cloud Build GitHub App)"
4. Authenticate with GitHub
5. Select repository: `laasna/gcp-opa-policies`
6. Create trigger with these settings:
   - **Name**: `opa-policy-validation`
   - **Event**: Push to a branch
   - **Branch**: `^main$`
   - **Configuration**: Cloud Build configuration file
   - **Location**: Repository - `cloudbuild.yaml`

### Option B: GitHub Webhook
1. Go to Cloud Build Triggers
2. Click "Create Trigger"
3. Select "GitHub" as source
4. Connect to `laasna/gcp-opa-policies`
5. Configure trigger settings

## Step 5: Test the Integration

### Test Commands:
```bash
# Trigger a build manually
gcloud builds submit --config=cloudbuild.yaml .

# Or push a test commit to trigger automatically
echo "# Test Cloud Build" >> README.md
git add README.md
git commit -m "Test Sanjana's Cloud Build integration"
git push
```

## Step 6: Demo Preparation

### What This Enables for Demo:
1. **Live CI/CD Pipeline**: Show actual Cloud Build running
2. **Real GCP Integration**: Demonstrate with actual GCP project
3. **Policy Enforcement**: Show policies blocking real deployments
4. **Audit Trail**: Show build history and logs
5. **Team Collaboration**: Demonstrate shared infrastructure

### Demo Flow with Sanjana's GCP:
1. **Show GitHub Repository**: Both team members have access
2. **Make a Policy Violation**: Push code that violates policies
3. **Watch Cloud Build Fail**: Live demonstration of policy enforcement
4. **Fix the Violation**: Push compliant code
5. **Watch Cloud Build Succeed**: Show successful deployment
6. **Show Build History**: Demonstrate audit trail

## Monitoring and Logs

### View Build Status:
- [Cloud Build History](https://console.cloud.google.com/cloud-build/builds?project=SANJANA-PROJECT-ID)
- [Cloud Build Logs](https://console.cloud.google.com/logs/query?project=SANJANA-PROJECT-ID)

### Key Metrics to Show:
- Build success/failure rates
- Policy violation detection
- Build duration (typically 2-3 minutes)
- Detailed error messages for violations

## Troubleshooting

### Common Issues:
1. **Billing not enabled**: Sanjana needs to enable billing
2. **API not enabled**: Run the `gcloud services enable` commands
3. **Permission denied**: Check service account permissions
4. **GitHub connection**: Re-authenticate if needed

### Support Resources:
- [Cloud Build Documentation](https://cloud.google.com/build/docs)
- [GitHub Integration Guide](https://cloud.google.com/build/docs/automating-builds/github/connect-repo-github)
- Project team for specific configuration questions

## Security Considerations

### Best Practices:
- Use least-privilege service accounts
- Enable audit logging
- Regularly review IAM permissions
- Use Secret Manager for sensitive data
- Monitor build logs for security events

## Cost Optimization

### Cloud Build Pricing:
- First 120 build-minutes per day are free
- Additional minutes: $0.003 per build-minute
- Typical OPA validation build: 2-3 minutes
- Estimated cost for demo: $0 (within free tier)

## Next Steps After Demo

### Production Considerations:
1. **Multi-environment setup** (dev/staging/prod)
2. **Branch protection rules** in GitHub
3. **Notification integration** (Slack/Teams)
4. **Advanced policy testing** framework
5. **Policy exception workflow** for special cases